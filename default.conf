server{
    listen 8081;
    location / {
        root /home/jphouse/front;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    location ^~ /prod-api/ {
        rewrite /prod-api/(.*)$ /$1 break;
        proxy_pass http://127.0.0.1:8082;
    }
    location ^~ /dev-api/ {
        rewrite /dev-api/(.*)$ /$1 break;
        proxy_pass http://127.0.0.1:8082;
    }

}
server{
    listen 8091;
    location / {
        root /home/mcpx/front;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    location ^~ /prod-api/ {
        rewrite /prod-api/(.*)$ /$1 break;
        proxy_pass http://127.0.0.1:6039;
    }
    location ^~ /dev-api/ {
        rewrite /dev-api/(.*)$ /$1 break;
        proxy_pass http://127.0.0.1:6039;
    }

}
server {
    # 启用gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
    
    server_name buildingjp.com;
    listen 443 ssl;
    ssl_certificate /home/cert/buildingjp.com_chain.crt;
    ssl_certificate_key /home/cert/buildingjp.com_key.key;
    ssl_session_timeout 5m;
    # 使用此加密套件。
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;  
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;   # 修改protocols。
    ssl_prefer_server_ciphers on;
    location / {
        root /home/jphouse/web;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    location ^~ /user-api/ {
        proxy_pass http://127.0.0.1:8082;
    }
    location ^~ /prod-api/ {
        rewrite /prod-api/(.*)$ /$1 break;
        proxy_pass http://127.0.0.1:8082;
    }
}
server {
    server_name ai.buildingjp.com;
    listen 443 ssl;
    ssl_certificate /home/cert/ai.buildingjp.com.pem;
    ssl_certificate_key /home/cert/ai.buildingjp.com.key;
    ssl_session_timeout 5m;
    # 使用此加密套件。
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;   # 修改protocols。
    ssl_prefer_server_ciphers on;
    location / {
        proxy_pass http://127.0.0.1:8088;
        #root /home/jphouse/web;
        #index index.html;
    }
}
server {
    client_max_body_size 20m;
    server_name mcp-x.com www.mcp-x.com yixiu.ai;
    listen 443 ssl;
    ssl_certificate /home/mcpx/cert/mcp-x.com.crt;
    ssl_certificate_key /home/mcpx/cert/mcp-x.com.key;
    ssl_session_timeout 5m;
    # 使用此加密套件。
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;   # 修改protocols。
    ssl_prefer_server_ciphers on;
    location / {
        root /home/mcpx/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    location ^~ /user-api/ {
        proxy_pass http://127.0.0.1:6039;
    }
    # 聊天和代码生成接口 - SSE 流式响应（使用正则表达式匹配多个路径）
    location ~ ^/(app/webgen/chat/gen/code|chat/send|chat/send-with-files)$ {
        proxy_pass http://127.0.0.1:6039;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Connection '';
        proxy_http_version 1.1;
        chunked_transfer_encoding on;        
        
        # 添加响应头，明确告知nginx不要缓冲
        add_header X-Accel-Buffering no;
 
        # 禁用缓冲 - 核心配置
        proxy_buffering off;
        proxy_cache off;
        
        # 设置超时时间
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
    }
    # AI视频生成接口 - 增加超时时间（使用正则表达式匹配多个路径）
    location ~ ^/prod-api/ai/(video/generate|image/generate|image/edit)$ {
        rewrite /prod-api/(.*)$ /$1 break;
        proxy_pass http://127.0.0.1:6039;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Connection '';
        proxy_http_version 1.1;
        chunked_transfer_encoding on;

        # 禁用缓冲，支持 SSE 流式响应
        proxy_buffering off;
        proxy_cache off;
        add_header X-Accel-Buffering no;

        # 设置较长的超时时间（视频生成通常耗时较长）
        proxy_connect_timeout 1800s;
        proxy_send_timeout 1800s;
        proxy_read_timeout 1800s;

        # 增加客户端超时时间
        client_max_body_size 100M;
        client_body_timeout 1800s;
    }

    location ^~ /prod-api/profile/upload/ {
        alias /home/mcpx/upload/upload/;        # 注意末尾斜杠
        autoindex off;
        access_log off;
        add_header Cache-Control "public, max-age=31536000";
        try_files $uri =404;
        # 如需明确 webp 类型（一般已内置）：types { image/webp webp; }
    }

    # 通用 prod-api 代理（使用普通前缀匹配，让正则 location 优先）
    location /prod-api/ {
        rewrite /prod-api/(.*)$ /$1 break;
        proxy_pass http://127.0.0.1:6039;
    }
    location /download/ {
        alias /home/mcpx/dist/download/;
        autoindex on;
    }
    location ^~ /dist/ {
        # 改成你的实际部署目录（注意末尾有斜杠）
        alias /opt/tmp/code_deploy/;
        index index.html;
        autoindex off;

        # 优先命中文件或目录，否则 404
        try_files $uri $uri/ =404;
    }
}

server {
    listen 80;
    server_name ai.buildingjp.com;
    location / {
        proxy_pass http://127.0.0.1:8088;
    }
}
server {
    listen 80;
    server_name mcp-x.com www.mcp-x.com yixiu.ai;
    location / {
        return 301 https://www.mcp-x.com$request_uri;
    }
}

server {
    listen 80;
    server_name buildingjp.com www.buildingjp.com mansion-market.cn mansion-market.com.cn;
    location / {
       return 301 https://buildingjp.com;
    }
}
